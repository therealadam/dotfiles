[tools]
go = "latest"
node = "latest"
ruby = "latest"
python = "latest"
deno = "latest"
"gem:rails" = "latest"
"gem:bundler" = "latest"

[settings]
experimental = true

[tasks.backup]
description = 'Backup existing dotfiles to timestamped directory'
run = """
#!/usr/bin/env bash
set -euo pipefail

TARGET_DIR="${TARGET_DIR:-$HOME}"
BACKUP_DIR="$TARGET_DIR/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"

echo "üì¶ Backing up dotfiles from $TARGET_DIR"

# List of dotfiles to backup
DOTFILES=(
    ".zshrc"
    ".gitconfig"
    ".gitignore"
    ".tmux.conf"
    ".vimrc.bundles"
    ".ideavimrc"
    ".pryrc"
    ".railsrc"
    ".rspec"
)

BACKED_UP=0

for dotfile in "${DOTFILES[@]}"; do
    if [ -e "$TARGET_DIR/$dotfile" ] || [ -L "$TARGET_DIR/$dotfile" ]; then
        mkdir -p "$BACKUP_DIR"
        echo "  ‚Ü™ Backing up $dotfile"
        cp -P "$TARGET_DIR/$dotfile" "$BACKUP_DIR/"
        BACKED_UP=$((BACKED_UP + 1))
    fi
done

# Backup directories
if [ -d "$TARGET_DIR/.config/mise" ]; then
    mkdir -p "$BACKUP_DIR/.config"
    echo "  ‚Ü™ Backing up .config/mise"
    cp -R "$TARGET_DIR/.config/mise" "$BACKUP_DIR/.config/"
    BACKED_UP=$((BACKED_UP + 1))
fi

if [ -d "$TARGET_DIR/.claude" ]; then
    mkdir -p "$BACKUP_DIR"
    echo "  ‚Ü™ Backing up .claude"
    cp -R "$TARGET_DIR/.claude" "$BACKUP_DIR/"
    BACKED_UP=$((BACKED_UP + 1))
fi

if [ $BACKED_UP -gt 0 ]; then
    echo ""
    echo "‚úÖ Backed up $BACKED_UP item(s) to: $BACKUP_DIR"
else
    echo ""
    echo "‚ÑπÔ∏è  No dotfiles found to backup"
fi
"""

[tasks.setup]
description = 'Set up dotfiles by creating symlinks (use TARGET_DIR=/path to specify destination)'
run = """
#!/usr/bin/env bash
set -euo pipefail

DOTFILES="${DOTFILES_DIR:-$HOME/.dotfiles}"
TARGET_DIR="${TARGET_DIR:-$HOME}"

echo "üîó Setting up dotfiles from $DOTFILES to $TARGET_DIR"

# Create backup directory if needed
BACKUP_DIR="$TARGET_DIR/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"

# Function to link a file
link_file() {
    local src="$1"
    local dest="$2"

    # Create parent directory if needed
    mkdir -p "$(dirname "$dest")"

    # Backup existing file/symlink if it exists and isn't already pointing to our dotfiles
    if [ -e "$dest" ] || [ -L "$dest" ]; then
        if [ -L "$dest" ]; then
            current_target=$(readlink "$dest")
            if [[ "$current_target" == "$DOTFILES"* ]]; then
                echo "  ‚úì $dest already linked"
                return
            fi
        fi
        mkdir -p "$BACKUP_DIR"
        echo "  ‚Ü™ Backing up existing $dest"
        mv "$dest" "$BACKUP_DIR/"
    fi

    ln -s "$src" "$dest"
    echo "  ‚úì Linked $dest"
}

# Link dotfiles in root
link_file "$DOTFILES/zshrc" "$TARGET_DIR/.zshrc"
link_file "$DOTFILES/gitconfig" "$TARGET_DIR/.gitconfig"
link_file "$DOTFILES/gitignore" "$TARGET_DIR/.gitignore"
link_file "$DOTFILES/tmux.conf" "$TARGET_DIR/.tmux.conf"
link_file "$DOTFILES/vimrc.bundles" "$TARGET_DIR/.vimrc.bundles"
link_file "$DOTFILES/ideavimrc" "$TARGET_DIR/.ideavimrc"
link_file "$DOTFILES/pryrc" "$TARGET_DIR/.pryrc"
link_file "$DOTFILES/railsrc" "$TARGET_DIR/.railsrc"
link_file "$DOTFILES/rspec" "$TARGET_DIR/.rspec"

# Link config directory
link_file "$DOTFILES/config/mise" "$TARGET_DIR/.config/mise"

# Link bin directory
if [ -d "$DOTFILES/bin" ]; then
    for script in "$DOTFILES/bin/"*; do
        if [ -f "$script" ]; then
            link_file "$script" "$TARGET_DIR/.local/bin/$(basename "$script")"
        fi
    done
fi

# Link claude directory
if [ -d "$DOTFILES/claude" ]; then
    link_file "$DOTFILES/claude" "$TARGET_DIR/.claude"
fi

echo ""
echo "‚úÖ Dotfiles setup complete!"
if [ -d "$BACKUP_DIR" ]; then
    echo "üì¶ Existing files backed up to: $BACKUP_DIR"
fi
"""

[tasks.unmanaged]
description = 'Find dotfiles that are not managed by this repository (use TARGET_DIR=/path to specify directory)'
run = """
#!/usr/bin/env bash
set -euo pipefail

DOTFILES="${DOTFILES_DIR:-$HOME/.dotfiles}"
TARGET_DIR="${TARGET_DIR:-$HOME}"

find "$TARGET_DIR" -maxdepth 1 -name '.*' -type f | while read file; do
  if [ -L "$file" ]; then
    target=$(readlink "$file")
    if [[ "$target" != "$DOTFILES"* ]]; then
      echo "$(basename "$file") (symlink to: $target)"
    fi
  else
    echo "$(basename "$file")"
  fi
done | sort
"""
