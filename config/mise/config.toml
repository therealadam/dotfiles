# mise u tool@version
[tools]
go = "latest"
node = "latest"
ruby = "3"
python = "latest"
deno = "latest"
"gem:rails" = "latest"
"gem:bundler" = "latest"

[settings]
experimental = true

# mise tasks
# List tasks: mise tasks
# Run task: mise run <task-name>

[tasks.setup]
description = 'Set up dotfiles by creating symlinks'
run = """
#!/usr/bin/env bash
set -euo pipefail

DOTFILES="${DOTFILES_DIR:-$HOME/.dotfiles}"
HOME_DIR="$HOME"

echo "ðŸ”— Setting up dotfiles from $DOTFILES to $HOME_DIR"

# Create backup directory if needed
BACKUP_DIR="$HOME_DIR/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"

# Function to link a file
link_file() {
    local src="$1"
    local dest="$2"

    # Create parent directory if needed
    mkdir -p "$(dirname "$dest")"

    # Backup existing file/symlink if it exists and isn't already pointing to our dotfiles
    if [ -e "$dest" ] || [ -L "$dest" ]; then
        if [ -L "$dest" ]; then
            current_target=$(readlink "$dest")
            if [[ "$current_target" == "$DOTFILES"* ]]; then
                echo "  âœ“ $dest already linked"
                return
            fi
        fi
        mkdir -p "$BACKUP_DIR"
        echo "  â†ª Backing up existing $dest"
        mv "$dest" "$BACKUP_DIR/"
    fi

    ln -s "$src" "$dest"
    echo "  âœ“ Linked $dest"
}

# Link dotfiles in root
link_file "$DOTFILES/zshrc" "$HOME_DIR/.zshrc"
link_file "$DOTFILES/gitconfig" "$HOME_DIR/.gitconfig"
link_file "$DOTFILES/gitignore" "$HOME_DIR/.gitignore"
link_file "$DOTFILES/tmux.conf" "$HOME_DIR/.tmux.conf"
link_file "$DOTFILES/vimrc.bundles" "$HOME_DIR/.vimrc.bundles"
link_file "$DOTFILES/ideavimrc" "$HOME_DIR/.ideavimrc"
link_file "$DOTFILES/pryrc" "$HOME_DIR/.pryrc"
link_file "$DOTFILES/railsrc" "$HOME_DIR/.railsrc"
link_file "$DOTFILES/rspec" "$HOME_DIR/.rspec"

# Link config directory
link_file "$DOTFILES/config/mise" "$HOME_DIR/.config/mise"

# Link bin directory
if [ -d "$DOTFILES/bin" ]; then
    for script in "$DOTFILES/bin/"*; do
        if [ -f "$script" ]; then
            link_file "$script" "$HOME_DIR/.local/bin/$(basename "$script")"
        fi
    done
fi

# Link claude directory
if [ -d "$DOTFILES/claude" ]; then
    link_file "$DOTFILES/claude" "$HOME_DIR/.claude"
fi

echo ""
echo "âœ… Dotfiles setup complete!"
if [ -d "$BACKUP_DIR" ]; then
    echo "ðŸ“¦ Existing files backed up to: $BACKUP_DIR"
fi
"""

[tasks.unmanaged]
description = 'Find dotfiles in ~ that are not managed by this repository'
run = """
#!/usr/bin/env bash
set -euo pipefail

DOTFILES="${DOTFILES_DIR:-$HOME/.dotfiles}"

find ~ -maxdepth 1 -name '.*' -type f | while read file; do
  if [ -L "$file" ]; then
    target=$(readlink "$file")
    if [[ "$target" != "$DOTFILES"* ]]; then
      echo "$(basename "$file") (symlink to: $target)"
    fi
  else
    echo "$(basename "$file")"
  fi
done | sort
"""
